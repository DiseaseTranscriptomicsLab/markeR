---
title: "Debugging"
output: html_notebook
---

# Import Data

```{r}
corrcounts_merge <- readRDS("~/VersionControl/senescence_benchmarking/Data/corrcounts_merge.rds")
metadata_merge <- readRDS("~/VersionControl/senescence_benchmarking/Data/metadata_merge.rds")
SenescenceSignatures <- readRDS("~/VersionControl/senescence_benchmarking/CommonFiles/SenescenceSignatures_divided_newCellAge.RDS")
```

```{r}
library(markeR)
library(ggplot2)
library(ggpubr)
library(edgeR)
?markeR
```

# Scores 

```{r}
?CalculateScores
```

## Unidirectional
```{r fig.width=12, fig.height=6}
df_ssGSEA <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "ssGSEA", gene_sets = SenescenceSignatures)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_ssGSEA, ColorVariable = "CellType", GroupingVariable="Condition",  method ="ssGSEA", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 6, nrow = 2, widthTitle=20, y_limits = NULL, legend_nrow = 2,cond_cohend=cond_cohend)

```

```{r fig.width=12, fig.height=6}
df_logmedian <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "logmedian", gene_sets = SenescenceSignatures)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_logmedian, ColorVariable = "CellType", GroupingVariable="Condition",  method ="logmedian", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 6, nrow = 2, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```

```{r fig.width=12, fig.height=6}
df_ranking <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "ranking", gene_sets = SenescenceSignatures)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_ranking, ColorVariable = "CellType", GroupingVariable="Condition",  method ="ranking", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 6, nrow = 2, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```

```{r}
wrap_title_aux <- function(title, width = 30) {
  if (nchar(title) <= width) {
    return(title)  # No need to wrap if it fits
  }
  
  wrapped_title <- ""
  while (nchar(title) > width) {
    # Find positions of capital letters and symbols near the wrap point
    capital_pos <- gregexpr("[A-Z]", title)[[1]]
    symbol_pos <- gregexpr("(_|-|:)", title)[[1]]
    
    # Check for symbol breaks within the last few characters (width - 5 to width)
    valid_symbol_breaks <- symbol_pos[symbol_pos >= (width - 5) & symbol_pos <= width]
    
    if (length(valid_symbol_breaks) > 0) {
      # If a suitable symbol is found, break at the first valid symbol
      break_at <- valid_symbol_breaks[1]
    } else {
      # If no suitable symbol, look for capital letters within the same range
      valid_capital_breaks <- capital_pos[capital_pos >= (width - 5) & capital_pos <= width]
      
      if (length(valid_capital_breaks) > 0) {
        # If a capital letter is found, break just before the capital letter
        break_at <- valid_capital_breaks[1] - 1
      } else {
        # If no suitable symbol or capital letter, break at width
        break_at <- width
      }
    }
    
    # Append the wrapped line
    wrapped_title <- paste0(wrapped_title, substr(title, 1, break_at), "\n")
    
    # Update title with the remaining text after the break
    title <- substr(title, break_at + 1, nchar(title))
  }
  
  # Add the remaining part of the title
  wrapped_title <- paste0(wrapped_title, title)
  
  return(wrapped_title)
}
```


```{r fig.width=12, fig.height=8}

plotlist <- list()

for (sig in names(df_ssGSEA)){
  
  df_subset_ssGSEA <- df_ssGSEA[[sig]]
  df_subset_logmedian <- df_logmedian[[sig]]
  
  df_subset_merge <- merge(df_subset_ssGSEA,df_subset_logmedian,by="sample")
  
  # Wrap the signature name using the helper function
  wrapped_title <- wrap_title_aux(sig, width = 20)  
  
  plotlist[[sig]] <- ggplot2::ggplot(df_subset_merge, aes(x=score.x, y=score.y)) +
    geom_point(size=4, alpha=0.8, fill="darkgrey", shape=21) +
    theme_bw() +
    xlab("ssGSEA Enrichment Score") +
    ylab("Normalised Signature Score") +
    ggtitle(wrapped_title) +
    theme(plot.title = ggplot2::element_text(hjust = 0.5, size=10),
          plot.subtitle = ggplot2::element_text(hjust = 0.5)) 
  
}

ggpubr::ggarrange(plotlist=plotlist, nrow=3, ncol=4, align = "h")
```

## Bidirectional gene signatures

Try scores with bidirectional signatures

```{r}
bidirectsigs <- readRDS("~/VersionControl/senescence_benchmarking/CommonFiles/SenescenceSignatures_complete_newCellAge.RDS")
for (sig in names(bidirectsigs)){
  sigdf <- bidirectsigs[[sig]]
  sigdf <- sigdf[,1:2] # remove the third column, if applicable
  if(any(sigdf[,2]=="not_reported")){
    sigdf <- sigdf[,1]
    bidirectsigs[[sig]] <- sigdf
    next 
  }
  sigdf[,2] <- ifelse(sigdf[,2]=="enriched",1,-1)
  bidirectsigs[[sig]] <- sigdf
}
bidirectsigs

```

```{r fig.width=8, fig.height=10}
df_logmedian <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "logmedian", gene_sets = bidirectsigs)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_logmedian, ColorVariable = "CellType", GroupingVariable="Condition",  method ="logmedian", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 3, nrow = 3, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```


```{r fig.width=8, fig.height=10}

df_ssgsea <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "ssGSEA", gene_sets = bidirectsigs)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_ssgsea, ColorVariable = "CellType", GroupingVariable="Condition",  method ="ssGSEA", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 3, nrow = 3, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```




```{r fig.width=8, fig.height=10}

df_ranking <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "ranking", gene_sets = bidirectsigs)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_ranking, ColorVariable = "CellType", GroupingVariable="Condition",  method ="ranking", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 3, nrow = 3, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```



## Heatmap for Cohen's D

```{r fig.width=20, fig.height=4}

# Helper function to compute Cohen's d
cohen_d <- function(x, y) {
  n1 <- length(x)
  n2 <- length(y)
  if(n1 < 2 || n2 < 2) return(NA)
  m1 <- mean(x)
  m2 <- mean(y)
  s1 <- sd(x)
  s2 <- sd(y)
  pooled_sd <- sqrt(((n1 - 1) * s1^2 + (n2 - 1) * s2^2) / (n1 + n2 - 2))
  if (pooled_sd == 0) return(NA)
  d <- (m1 - m2) / pooled_sd
  d <- abs(d) # dor this application we don't need the direction of the classification, just if it works
  return(d)
}

compute_cohen_d <- function(dfScore, variable, quantitative_var="score") { 
  
  # Get unique group values
  unique_groups <- unique(dfScore[[variable]])
  
  # Ensure there are at least two groups
  if (length(unique_groups) < 2) {
    stop("The grouping column must have at least two unique values.")
  }
  
  
  
  # Store results
  results <- data.frame(Group1 = character(), Group2 = character(), 
                        CohenD = numeric(), PValue = numeric(), stringsAsFactors = FALSE)
  
  # Compute Cohen's d and p-value for all unique pairs
  combs <- combn(unique_groups, 2, simplify = FALSE)
  for (pair in combs) {
    x <- dfScore[dfScore[[variable]] == pair[1], quantitative_var, drop = TRUE]
    y <- dfScore[dfScore[[variable]] == pair[2], quantitative_var, drop = TRUE]
    
    d <- cohen_d(x, y)
    p_val <- t.test(x, y, var.equal = TRUE)$p.value
    
    results <- rbind(results, data.frame(Group1 = pair[1], Group2 = pair[2], 
                                         CohenD = d, PValue = p_val, stringsAsFactors = FALSE))
  }
  
  return(results)
}


# Function to flatten the list of lists into a data frame
flatten_results <- function(nested_list) {
  # Create an empty list to store results
  result_list <- list()
  
  # Iterate over methods (first level)
  for (method in names(nested_list)) {
    # Iterate over gene signatures (second level)
    for (signature in names(nested_list[[method]])) {
      # Extract the data frame (third level)
      df <- nested_list[[method]][[signature]]
      
      # Add columns for method and signature
      df$method <- method
      df$signature <- signature
      
      # Store the modified data frame in the list
      result_list[[paste(method, signature, sep = "_")]] <- df
    }
  }
  
  # Combine all data frames into one
  final_df <- do.call(rbind, result_list)
  
  # Reset row names
  rownames(final_df) <- NULL
  
  return(final_df)
}


CohenD_allConditions <- function(data, metadata, gene_sets, variable) {
  
  # Step 1: Check if variable exists in metadata
  if (!variable %in% colnames(metadata)) {
    stop(paste("Error: Variable", variable, "not found in metadata."))
  }
  
  # Step 2: Compute scores for all methods and signatures
  listScores <- CalculateScores(data = data, metadata = metadata, gene_sets = gene_sets, method = "all") 
  
  # Step 3: Flatten into a data frame with method & signature columns
  dfScores <- flatten_results(listScores)
  
  # Step 4: Initialize result list
  result_list <- list()
  
  # Step 5: Loop through each signature
  for (signature in unique(dfScores$signature)) {
    
    # Filter for the specific signature
    df_subset <- dfScores[dfScores$signature == signature, ]
    
    # Initialize storage for this signature
    cohen_d_results <- list()
    p_value_results <- list()
    
    # Step 6: Loop through each method
    for (method in unique(df_subset$method)) {
      
      # Subset data for this method
      df_method <- df_subset[df_subset$method == method, ]
      
      # Compute Cohen's d and p-values
      cohen_results <- compute_cohen_d(df_method, variable)
      
      # Convert to named vectors (column names = comparisons)
      cohen_d_results[[method]] <- setNames(cohen_results$CohenD, paste0(cohen_results$Group1, ":", cohen_results$Group2))
      p_value_results[[method]] <- setNames(cohen_results$PValue, paste0(cohen_results$Group1, ":", cohen_results$Group2))
    }
    
    # Convert lists to data frames
    cohen_d_df <- as.data.frame(do.call(rbind, cohen_d_results))
    p_value_df <- as.data.frame(do.call(rbind, p_value_results))
    
    # Store results in the named list
    result_list[[signature]] <- list(CohenD = cohen_d_df, PValue = p_value_df)
  }
  
  # Step 7: Return the list
  return(result_list)
}



#' @importFrom ComplexHeatmap %v%

Heatmap_CohenD <- function(data, metadata, gene_sets, variable, orientation=c("grid","horizontal","vertical"), limits=NULL, cluster_columns = TRUE, cluster_rows= TRUE, subtitlewidth=20) {
  
  orientation <- match.arg(orientation)
  
  cohenlist <- CohenD_allConditions(data=data, metadata=metadata, gene_sets=gene_sets, variable=variable)
  
  # Create a list to store the heatmap objects
  heatmaps <- list() 
  # Generate a heatmap for each signature
  for (signature in names(cohenlist)) {
    
    # Ensure Cohen's d and p-value are matrices
    cohen_d_mat <- as.matrix(cohenlist[[signature]]$CohenD)
    p_value_mat <- as.matrix(cohenlist[[signature]]$PValue)
    
    # Format text labels
    text_labels <- matrix(
      paste0(
        sprintf("%.2f", cohen_d_mat),  # Round Cohen's d to 2 decimals
        " \n(",
        format.pval(p_value_mat, digits = 1),  # Format p-value
        ")"
      ), 
      nrow = nrow(cohen_d_mat), 
      ncol = ncol(cohen_d_mat)
    )
    
    # Use user-provided limits or default ones
    if (is.null(limits)) limits <- c(min(cohen_d_mat), max(cohen_d_mat))
    
    # Create heatmap
    col_fun <- circlize::colorRamp2(limits, c("#F9F4AE" ,"#B44141"))
    ht <- ComplexHeatmap::Heatmap(
      t(cohen_d_mat),
      name = "Cohen's d",
      column_title = wrap_title(signature, subtitlewidth),
      show_row_names = TRUE,
      show_column_names = TRUE,
      cluster_rows = cluster_rows,
      cluster_columns = cluster_columns,
      cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(text_labels[i, j], x, y, gp = gpar(fontsize = 10, col = "black"))
      },
      col = col_fun
    )
    
    
    
    if (orientation=="grid"){
      # Add the heatmap to the list; but in grob so we can combine
      heatmaps[[signature]] <- invisible(grid.grabExpr(ComplexHeatmap::draw(ht)))
    }  else {
      heatmaps[[signature]] <- ht
    }
    
  }
  
  
  
  # combine all heatmaps with a common color scale in only one row
  
  # The user can choose to do it in only one row or only one column
  if (orientation=="horizontal"){
    
    for (i in 1:length(heatmaps)) {
      heatmap_row <- heatmaps   # Extract remaining heatmaps
      Heatmap_Final <- heatmaps[[1]]  # Start with the first heatmap in the row
      while (length(heatmap_row) > 0) {
        Heatmap_Final <- Heatmap_Final + heatmap_row[[1]]  # Combine horizontally
        heatmap_row <- heatmap_row[-1]  # Remove the used heatmap
      }
    }
    
  } else if (orientation == "vertical"){
    
    for (i in 1:length(heatmaps)) {
      heatmap_row <- heatmaps   # Extract remaining heatmaps
      Heatmap_Final <- heatmaps[[1]]  # Start with the first heatmap in the row
      while (length(heatmap_row) > 0) {
        Heatmap_Final <- Heatmap_Final %v% heatmap_row[[1]]  # Combine horizontally
        heatmap_row <- heatmap_row[-1]  # Remove the used heatmap
      }
    }
  
    
  } else if (orientation == "grid"){
    
    # Determine grid layout
    num_signatures <- length(cohenlist)
    if (is.null(ncol) && is.null(nrow)) {
      ncol <- ceiling(sqrt(num_signatures))
      nrow <- ceiling(num_signatures / ncol)
    } else if (is.null(ncol)) {
      ncol <- ceiling(num_signatures / nrow)
    } else if (is.null(nrow)) {
      nrow <- ceiling(num_signatures / ncol)
    }
    
    
    Heatmap_Final <- grid.arrange(grobs = heatmaps, 
                                  ncol = ncol, 
                                  nrow = nrow)
    
  } 
   
  return(Heatmap_Final)
}
 
```



```{r fig.width=15, fig.height=12}
test <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "all", gene_sets = bidirectsigs)
flatten_results(test)

options(error=recover)
cohenlist <- CohenD_allConditions(data=corrcounts_merge, metadata=metadata_merge, gene_sets=bidirectsigs, variable="Condition")

Heatmap_CohenD(data = corrcounts_merge, metadata = metadata_merge,gene_sets = bidirectsigs, variable="Condition", orientation = "grid",limits = c(0,2), cluster_columns = F, cluster_rows = F, subtitlewidth = 20)

# missing: 
# - combine legends
# - wrap title
# - tilt x labels to 60 degrees
# - change default colors
# wrap x labels with wrap_title
# grid with common legends https://support.bioconductor.org/p/87318/


```









# Individual Genes

### Violin Expression Plots

```{r fig.width=8, fig.height=6}


senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)


IndividualGenes_Violins(data = corrcounts_merge, metadata = metadata_merge, genes = c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"), GroupingVariable = "Condition", plot=T, ncol=NULL, nrow=2, divide="CellType", invert_divide=FALSE,ColorValues=senescence_triggers_colors, pointSize=2, ColorVariable="SenescentType", title="Senescence", widthTitle=16,y_limits = NULL,legend_nrow=4, xlab="Condition",colorlab="") 
```



### Correlation Heatmap


```{r fig.width=8, fig.height=4}
options(error=recover)
CorrelationHeatmap(data=corrcounts_merge, 
                   metadata = metadata_merge, 
                   genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"), 
                   separate.by = "Condition", 
                   method = "pearson",  
                   colorlist = list(low = "#3F4193", mid = "#F9F4AE", high = "#B44141"),
                   limits_colorscale = c(-1,0,1), 
                   widthTitle = 16, 
                   title = "test", 
                   cluster_rows = TRUE, 
                   cluster_columns = TRUE,  
                   detailedresults = FALSE, 
                   legend_position="right",
                   titlesize=20)


```




### Expression Heatmaps

```{r fig.width=10, fig.height=4}
options(error=recover)

annotation_colors <- list(
  CellType = c(
    "Fibroblast"   = "#FF6961",   # Strong Pastel Red  
    "Keratinocyte" = "#FFB347",   # Strong Pastel Orange  
    "Melanocyte"   = "#FFD700",   # Strong Pastel Yellow  
    "Endothelial"  = "#77DD77",   # Strong Pastel Green  
    "Neuronal"     = "#779ECB",   # Strong Pastel Blue  
    "Mesenchymal"  = "#C27BA0"    # Strong Pastel Purple  
  ),
  Condition = c(
    "Senescent"     = "#65AC7C",  # Example color: greenish
    "Proliferative" = "#5F90D4",  # Example color: blueish
    "Quiescent"     = "#EDA03E"   # Example color: orange
  )
)

ExpressionHeatmap(data=corrcounts_merge, 
                  metadata = metadata_merge, 
                  genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"),  
                  annotate.by = c("CellType","Condition"),
                  annotation_colors = annotation_colors,
                  colorlist = list(low = "#3F4193", mid = "#F9F4AE", high = "#B44141"),
                  cluster_rows = TRUE, 
                  cluster_columns = FALSE,
                  title = "test", 
                  titlesize = 20,
                  legend_position = "right",
                  scale_position="right")

```



### ROC/AUC 

```{r fig.width=10, fig.height=4}

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

ROCandAUCplot(corrcounts_merge, 
              metadata_merge, 
              condition_var = "Condition", 
              class = "Senescent", 
              genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"), 
              group_var="CellType",
              plot_type = "all",
              heatmap_params = list(col = list( "#F9F4AE" ,"#B44141"),
                                    limits = c(0.5,1),
                                    cluster_rows=T),
              roc_params = list(nrow=2,
                                ncol=2,
                                colors=cellTypes_colors),
              commomplot_params = list(widths=c(0.5,0.5)))


```

### Cohen's d

```{r}
CohenDHeatmap(corrcounts_merge, 
              metadata_merge, 
              genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"),
              condition_var = "Condition", 
              class = "Senescent", 
              group_var = "CellType",
              title = NULL,
              widthTitle = 16,
              heatmap_params = list(col = list( "#F9F4AE" ,"#B44141"),
                                    limits = NULL,
                                    cluster_rows=T))
```

### PCA with genes from signature only

```{r fig.width=8, fig.height=4}

CellTypecols = c(
  "Fibroblast"   = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347",   # Strong Pastel Orange  
  "Melanocyte"   = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial"  = "#77DD77",   # Strong Pastel Green  
  "Neuronal"     = "#779ECB",   # Strong Pastel Blue  
  "Mesenchymal"  = "#C27BA0"    # Strong Pastel Purple  
)

sencols <- c(
  "Senescent" = "#D32F2F",  # Strong salmon  
  "Quiescent" = "#FFB74D",  # Bright peach  
  "Proliferative" = "#9575CD"  # Deep pastel purple  
)

plotPCA(data=corrcounts_merge, 
        metadata=metadata_merge, 
        genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"), 
        scale=FALSE, 
        center=TRUE, 
        PCs=list(c(1,2), c(2,3), c(3,4)), 
        ColorVariable="Condition",
        ColorValues=sencols,
        pointSize=5,
        legend_nrow=1, 
        ncol=3, 
        nrow=NULL)
```



---
title: "Debugging"
output: html_notebook
---

# Import Data

```{r}
corrcounts_merge <- readRDS("~/VersionControl/senescence_benchmarking/Data/corrcounts_merge.rds")
metadata_merge <- readRDS("~/VersionControl/senescence_benchmarking/Data/metadata_merge.rds")
SenescenceSignatures <- readRDS("~/VersionControl/senescence_benchmarking/CommonFiles/SenescenceSignatures_divided_newCellAge.RDS")
```

```{r}
set.seed("123456")
metadata_merge_corr <- metadata_merge
metadata_merge_corr$random_cat <-  sample(c("A","B","C"), nrow(metadata_merge_corr), replace = T)
metadata_merge_corr$random_numeric <- sample(0:100, nrow(metadata_merge_corr), replace = TRUE)
metadata_merge_corr$Is_Senescent <- ifelse(metadata_merge_corr$Condition == "Senescent", "Senescent", "Non Senescent")

```


```{r}
library(markeR)
library(ggplot2)
library(ggpubr)
library(edgeR)
library(effectsize)  # For eta_squared and Cohen's f calculation
?markeR
```

# Scores 

```{r}
?CalculateScores
```

## Unidirectional
```{r fig.width=12, fig.height=6}
df_ssGSEA <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "ssGSEA", gene_sets = SenescenceSignatures)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_ssGSEA, ColorVariable = "CellType", GroupingVariable="Condition",  method ="ssGSEA", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 6, nrow = 2, widthTitle=20, y_limits = NULL, legend_nrow = 2,cond_cohend=cond_cohend)

```

```{r fig.width=12, fig.height=6}
df_logmedian <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "logmedian", gene_sets = SenescenceSignatures)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_logmedian, ColorVariable = "CellType", GroupingVariable="Condition",  method ="logmedian", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 6, nrow = 2, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```

```{r fig.width=12, fig.height=6}
df_ranking <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "ranking", gene_sets = SenescenceSignatures)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_ranking, ColorVariable = "CellType", GroupingVariable="Condition",  method ="ranking", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 6, nrow = 2, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```


```{r fig.width=12, fig.height=8}

plotlist <- list()

for (sig in names(df_ssGSEA)){
  
  df_subset_ssGSEA <- df_ssGSEA[[sig]]
  df_subset_logmedian <- df_logmedian[[sig]]
  
  df_subset_merge <- merge(df_subset_ssGSEA,df_subset_logmedian,by="sample")
  
  # Wrap the signature name using the helper function
  wrapped_title <- wrap_title_aux(sig, width = 20)  
  
  plotlist[[sig]] <- ggplot2::ggplot(df_subset_merge, aes(x=score.x, y=score.y)) +
    geom_point(size=4, alpha=0.8, fill="darkgrey", shape=21) +
    theme_bw() +
    xlab("ssGSEA Enrichment Score") +
    ylab("Normalised Signature Score") +
    ggtitle(wrapped_title) +
    theme(plot.title = ggplot2::element_text(hjust = 0.5, size=10),
          plot.subtitle = ggplot2::element_text(hjust = 0.5)) 
  
}

ggpubr::ggarrange(plotlist=plotlist, nrow=3, ncol=4, align = "h")
```

## Bidirectional gene signatures

Try scores with bidirectional signatures

```{r}
bidirectsigs <- readRDS("~/VersionControl/senescence_benchmarking/CommonFiles/SenescenceSignatures_complete_newCellAge.RDS")
for (sig in names(bidirectsigs)){
  sigdf <- bidirectsigs[[sig]]
  sigdf <- sigdf[,1:2] # remove the third column, if applicable
  if(any(sigdf[,2]=="not_reported")){
    sigdf <- sigdf[,1]
    bidirectsigs[[sig]] <- sigdf
    next 
  }
  sigdf[,2] <- ifelse(sigdf[,2]=="enriched",1,-1)
  bidirectsigs[[sig]] <- sigdf
}
bidirectsigs

```

```{r fig.width=8, fig.height=10}
df_logmedian <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "logmedian", gene_sets = bidirectsigs)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_logmedian, ColorVariable = "CellType", GroupingVariable="Condition",  method ="logmedian", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 3, nrow = 3, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```


```{r fig.width=8, fig.height=10}

df_ssgsea <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "ssGSEA", gene_sets = bidirectsigs)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_ssgsea, ColorVariable = "CellType", GroupingVariable="Condition",  method ="ssGSEA", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 3, nrow = 3, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```




```{r fig.width=8, fig.height=10}

df_ranking <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge, method = "ranking", gene_sets = bidirectsigs)

senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

cond_cohend <- list(A=c("Senescent"), # if no variable is defined, will be the first that appears in the ggplot
                    B=c("Proliferative","Quiescent"))

PlotScores(ResultsList = df_ranking, ColorVariable = "CellType", GroupingVariable="Condition",  method ="ranking", ColorValues = cellTypes_colors, ConnectGroups=TRUE, ncol = 3, nrow = 3, widthTitle=20, y_limits = NULL, legend_nrow = 2,xlab=NULL, cond_cohend = cond_cohend)

```



## Heatmap for Cohen's D




```{r fig.width=15, fig.height=12}

PlotScores(data = corrcounts_merge, 
           metadata = metadata_merge,  
           gene_sets=bidirectsigs, 
           GroupingVariable="Condition",  
           method ="all",   
           ncol = NULL, 
           nrow = NULL, 
           widthTitle=30, 
           limits = NULL,   
           title="Marthandan et al. 2016", 
           titlesize = 12,
           ColorValues = NULL)  


# missing: 
# - combine legends
# - wrap title
# - tilt x labels to 60 degrees
# - change default colors
# wrap x labels with wrap_title
# grid with common legends https://support.bioconductor.org/p/87318/


```


## Association with Variable

If the user is investigating if a certain variable can be described from the score, and not already knowing that variable. More exploratory...

- Define what each variable is: Numeric (includes integer if unique > 5), Categorical Bin (integer/string if unique == 2, logical), Categorical Multi (integer if unique < 5, string if unique > 2)
- Define functions to calculate metrics based on different data types: 
- Categorical Bin: t-test/wilcoxon
- Categorical Multi: ANOVA / Kruskal-Wallis + Tukey's test 
- Numeric : Pearson / Spearman / Kendall's Tau
- Return a list:
- One entry per variable
- Method used
- Data frame
- Two columns: metric and p-value
- One line per subvariable (if Numeric and Categorical Bin, only one line; for Categorical Multi, one per combination of variables); named rows
- Plot results
- If Numeric, scatter plot; metric on the top left corner
- If Categorical, density plot, colored by the unique values of the variable; metrics (if one, or combinations of variables) in top left corner
- Arrange in grid

```{r}
# metadata_corr <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge_corr, method = "ssGSEA", gene_sets = list(HernandezSegura_UP= SenescenceSignatures$`[UP]_HernandezSegura`))
# metadata_corr <- metadata_corr$HernandezSegura_UP
```

```{r fig.width=14, fig.height=3}
options(error=recover)
VariableAssociation(df=metadata_corr, target_var="score", cols = c("Condition","Is_Senescent","random_cat","random_numeric"),
                    discrete_colors = list(Is_Senescent=c("Senescent"="pink",
                                                          "Non Senescent"="orange")), 
                    continuous_color = "#8C6D03", 
                    color_palette = "Set2", nrow=1, sizeannot=3, legend.position="right")
```

Looking for an universal metric...

```{r}

compute_cohens_f_pval <- function(model, predictor, type) {
  eta_sq_value <- effectsize::eta_squared(model, partial = FALSE)$Eta2
  cohen_f <- sqrt(eta_sq_value / (1 - eta_sq_value))  # Convert η² to Cohen's f
  
  # Get p-value
  if (type=="Numeric") {
    # Numeric predictor: get p-value from regression summary
    #For numeric predictors (continuous variables): The t-test from summary(lm(...)) is appropriate because it directly tests the significance of the slope.
    p_value <- summary(model)$coefficients[2, 4]
  } else {
    # Categorical predictor: get p-value from ANOVA
    #For categorical predictors (binary or multi-level): The F-test from anova(lm(...)) is preferred because it tests for overall group differences.
    p_value <- anova(model)$`Pr(>F)`[1]
  }
  
  return(c(Cohen_f = cohen_f, P_Value = p_value))
}


```


```{r}

remove_division <- function(contrasts) {
  gsub("\\)/[0-9]+", ")", contrasts)  # Removes "/2", "/3", etc. after parentheses
}

create_contrast_column <- function(metadata, variable_name, contrast) {
  # Extract left and right sides of the contrast
  sides <- strsplit(contrast, " - ")[[1]]
  
  left_side <- gsub("[()]", "", sides[1])  # Remove parentheses
  right_side <- gsub("[()]", "", sides[2]) # Remove parentheses
  
  # Split into individual levels
  left_levels <- unlist(strsplit(left_side, " \\+ "))
  right_levels <- unlist(strsplit(right_side, " \\+ "))

  # Keep only relevant rows (samples in the contrast)
  relevant_metadata <- metadata[metadata[[variable_name]] %in% c(left_levels, right_levels), ]
  
  # Create new column with labels based on the contrast
  relevant_metadata$cohentest <- ifelse(relevant_metadata[[variable_name]] %in% right_levels, 
                                         right_side, 
                                         left_side)
  
  return(relevant_metadata)  # Return only the relevant subset
}
 


Score_VariableAssociation <- function(data, metadata, cols, method=c("logmedian","ssGSEA","ranking"), gene_set, mode=c("simple","medium","extensive"), nonsignif_color = "grey", signif_color = "red", saturation_value=NULL,sig_threshold = 0.05, widthlabels=18, labsize=10, title=NULL, titlesize=14, pointSize=5, discrete_colors=NULL,  continuous_color = "#8C6D03", color_palette = "Set2"){
  
  # calculate scores for a given metric
  df_ranking <- CalculateScores(data = data, metadata = metadata, method = method, gene_sets = gene_set)[[1]] # if more than one gene set is provided, only results for the first one will be returned
  
  
  # Initialise results data frame  
  df_results_overall <- data.frame(Variable = NULL,
                                   cohen_f = NULL,
                                   p_value = NULL)
  
    df_results_contrast <- data.frame(Contrast = NULL,
                                      Group1 = NULL,
                                   Group2 = NULL,
                                   CohenD = NULL,
                                   PValue = NULL)
  
  for (var in cols) {
    
    # Check if the variable exists in metadata
    if (!(var %in% colnames(metadata))) {
      warning(paste0("Variable ", var, " not in metadata"))
      next  # Skip to the next iteration if the variable is not in metadata
    }
    
    ########### OVERALL MODE ############
    
    # for each variable, fit a linear model between the score and that variable
    # Define variable type (numeric or non numeric)
    type <- identify_variable_type(metadata, var)[var]
    #Without scaling, the coefficient represents the change in score per unit increase in the variable (if numeric, the unit of the variable. Makes sense to not scale...)
    model <- lm(score ~ get(var), data = df_ranking)   
    results_var <- compute_cohens_f_pval(model, predictor, type) 
    
    df_results_overall <- rbind(
      df_results_overall, 
      data.frame(
        Variable = var, 
        Cohen_f = results_var["Cohen_f"], 
        P_Value = results_var["P_Value"], 
        stringsAsFactors = FALSE,
        row.names = NULL
      )
    )  
    
    ########### CONTRASTS MODE ############
    
  if (type =="Numeric"){
    next
  }
    contrasts <- generate_all_contrasts(unique(df_ranking[[var]]), mode = mode)
    contrasts <- remove_division(contrasts)
    
    for (cont in contrasts){
      
       metadata_cohentest <- create_contrast_column(df_ranking, var, cont) # subsets metadata and adds new column "cohentest" with the two parts of the contrast 
       result_cohen_contrast <- compute_cohen_d(metadata_cohentest, "cohentest", quantitative_var="score") 
       df_results_contrast <-  rbind(df_results_contrast,
                                     data.frame(
                                       Variable = var,
                                       Contrast = paste0("(",result_cohen_contrast$Group1,") - (",result_cohen_contrast$Group2,")"),
                                       Group1 = result_cohen_contrast$Group1,
                                       Group2 = result_cohen_contrast$Group2,
                                       CohenD = result_cohen_contrast$CohenD,
                                       PValue = result_cohen_contrast$PValue), 
        stringsAsFactors = FALSE,
        row.names = NULL)
       
        
       
    }
     
    
  }
    
  df_results_contrast$padj <- p.adjust(df_results_contrast$PValue, method = "BH")  
  
  
  ########### CONTRAST MODE PLOT ############
  
  # Ensure contrast ordering
  df_results_contrast$Contrast <- sapply(df_results_contrast$Contrast, function(x) wrap_title(x, widthlabels))
  df_results_contrast$Contrast <- factor(df_results_contrast$Contrast, levels = df_results_contrast$Contrast[order(df_results_contrast$CohenD)])
 

  if(is.null(saturation_value)){
    if (min(df_results_contrast$padj)>sig_threshold){
      limit_pval <- 0.001
    } else{
      limit_pval <- min(df_results_contrast$padj)
    }

  } else {
    limit_pval <- saturation_value
  }


  plot_contrasts <- ggplot2::ggplot(df_results_contrast, ggplot2::aes(x = CohenD, y = Contrast, fill = -log10(padj))) +
    ggplot2::geom_segment(ggplot2::aes(
      yend = Contrast,
      xend = 0,
      linetype =  "solid",
      color =  "black"
    ), size = .5) +
    ggplot2::geom_point(ggplot2::aes(
      stroke = 1.2,
      color =   "black" 
    ), shape = 21, size = pointSize) + 
    ggplot2::scale_fill_gradient2(low = nonsignif_color,
                                  mid = nonsignif_color,
                                  high = signif_color,
                                  midpoint = -log10(sig_threshold),
                                  limits=c(0,-log10(limit_pval)),
                                  na.value = signif_color)+
  ggplot2::scale_linetype_identity() +
    ggplot2::scale_color_identity() +
    ggplot2::labs(  
      x = "Cohen's D",
      y = "Contrast",
      color = "-log10(Adj. p-value)",
      fill = "-log10(Adj. p-value)"
    ) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      plot.title = ggplot2::element_text(hjust = 0.5, face = "bold", size = titlesize),
      plot.subtitle = ggplot2::element_text(hjust = 0.5, face = "italic", size = titlesize - 2),
      legend.position = "top",
      axis.text = ggplot2::element_text(size = labsize)
    ) +
    ggplot2::facet_grid(Variable ~.,   scales = "free", switch = "y", space = "free" ) +
    theme(strip.background =element_rect(fill="white"))

    
  ########### OVERALL MODE PLOT ############
  
  plot_overall <- ggplot2::ggplot(df_results_overall, ggplot2::aes(x = Cohen_f, y = Variable, fill = -log10(P_Value))) +
    ggplot2::geom_segment(ggplot2::aes(
      yend = Variable,
      xend = 0,
      linetype =  "solid",
      color =  "black"
    ), size = .5) +
    ggplot2::geom_point(ggplot2::aes(
      stroke = 1.2,
      color =   "black" 
    ), shape = 21, size = pointSize) + 
    ggplot2::scale_fill_gradient2(low = nonsignif_color,
                                  mid = nonsignif_color,
                                  high = signif_color,
                                  midpoint = -log10(sig_threshold),
                                  limits=c(0,-log10(limit_pval)),
                                  na.value = signif_color)+
  ggplot2::scale_linetype_identity() +
    ggplot2::scale_color_identity() +
    ggplot2::labs(  
      x = "Cohen's F",
      y = "Variable",
      color = "-log10(p-value)",
      fill = "-log10(p-value)"
    ) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      plot.title = ggplot2::element_text(hjust = 0.5, face = "bold", size = titlesize),
      plot.subtitle = ggplot2::element_text(hjust = 0.5, face = "italic", size = titlesize - 2),
      legend.position = "top",
      axis.text = ggplot2::element_text(size = labsize)
    )
  
  
  
  ########### DISTRIBUTION VARS PLOT ############
  
  
  variable_types <- identify_variable_type(metadata, cols = cols)
  list_plts_var_distribution <- list()
  for (var in cols){
    
    # Check if the variable exists in metadata
    if (!(var %in% colnames(metadata))) {
      warning(paste0("Variable ", var, " not in metadata"))
      next  # Skip to the next iteration if the variable is not in metadata
    }
    
    # Adding p-value in parenthesis next to the metric
    if (variable_types[var] == "Numeric") { 
      
      list_plts_var_distribution[[var]] <- ggplot2::ggplot(df_ranking, ggplot2::aes_string(x = var, y = "score")) +
        ggplot2::geom_point(alpha = 0.6, size=4, color = continuous_color) +  # Use continuous_color
        ggplot2::geom_smooth(method = "lm", col = "black", se = FALSE, size=2) + 
        ggplot2::coord_cartesian(clip = "off") +  # Allow text outside the plot area
        ggplot2::theme_classic() +
        ggplot2::ggtitle(var) +
        ggplot2::labs(y=paste0("Score (",method,")")) +
        ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, face = "bold"))

    } else {
 
      # Check if user provided a custom named list for discrete colors
      if (!is.null(discrete_colors) && var %in% names(discrete_colors)) {
        # Use user-specified colors for the specific variable
        colors <- discrete_colors[[var]]
      } else {
        num_levels <- length(unique(df_ranking[[var]]))
        colors <- colorRampPalette(RColorBrewer::brewer.pal(8, color_palette))(num_levels)

      }

      list_plts_var_distribution[[var]] <- ggplot2:: ggplot(df_ranking, ggplot2::aes_string(x = "score", fill = var)) +
        ggplot2::geom_density(alpha = 0.6) +
        ggplot2::scale_fill_manual(values = colors) +  # Apply custom discrete colors 
        ggplot2::coord_cartesian(clip = "off") +
        ggplot2::theme_classic() +
        ggplot2::ggtitle(var) +
        ggplot2::labs(x = paste0("Score (",method,")"), y = "Density", fill="") +
        ggplot2::theme(legend.position = "right",
                       plot.title = ggplot2::element_text(hjust = 0.5, face = "bold"))
  }
  }
  
  plot_distributions <- ggarrange(plotlist = list_plts_var_distribution, ncol=1) 
  
  ########### ALL ############
  
  row1 <- ggarrange(plot_distributions,plot_contrasts, nrow=1, widths=c(0.4,0.6))
  plotfinal <- ggarrange(plot_overall, row1, ncol=1, heights=c(0.3,0.7))
  plotfinal <- ggpubr::annotate_figure(plotfinal, top = grid::textGrob(names(gene_set)[1], gp = grid::gpar(cex = 1.3, fontsize = titlesize, face="bold")))
  
  
  print(plotfinal)
  
  invisible(list(Overall=df_results_overall,
                 Contrasts = df_results_contrast, 
                 plot=plotfinal,
                 plot_contrasts=plot_contrasts, 
                 plot_overall=plot_overall, 
                 plot_distributions=list_plts_var_distribution))
  
  
}


```


```{r fig.height=8, fig.width=8}

Score_VariableAssociation(data=corrcounts_merge, metadata=metadata_merge_corr, cols = c("Condition","random_cat","random_numeric"), method="ranking", gene_set = list(HernandezSegura=bidirectsigs$HernandezSegura), mode = "extensive", nonsignif_color = "white", signif_color = "red", saturation_value=NULL,sig_threshold = 0.05, widthlabels=29, labsize=10, titlesize=14, pointSize=5)

```
 


# Individual Genes

### Violin Expression Plots

```{r fig.width=8, fig.height=6}


senescence_triggers_colors <- c(
  "none" = "#E57373",  # Soft red  
  "Radiation" = "#BDBDBD",  # Medium gray  
  "DNA damage" = "#64B5F6",  # Brighter blue  
  "Telomere shortening" = "#4FC3F7",  # Vivid sky blue  
  "DNA demethylation" = "#BA68C8",  # Rich lavender  
  "Oxidative stress" = "#FDD835",  # Strong yellow  
  "Conditioned Medium" = "#F2994A",  # Warm orange  
  "Oncogene" = "#81C784",  # Medium green  
  "Lipid Accumulation" = "#E57373",  # Coral  
  "Calcium influx" = "#26A69A",  # Deep teal  
  "Plasma membrane dysruption" = "#D32F2F",  # Strong salmon  
  "OSKM factors" = "#FFB74D",  # Bright peach  
  "YAP KO" = "#9575CD"  # Deep pastel purple  
)


IndividualGenes_Violins(data = corrcounts_merge, metadata = metadata_merge, genes = c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"), GroupingVariable = "Condition", plot=T, ncol=NULL, nrow=2, divide="CellType", invert_divide=FALSE,ColorValues=senescence_triggers_colors, pointSize=2, ColorVariable="SenescentType", title="Senescence", widthTitle=16,y_limits = NULL,legend_nrow=4, xlab="Condition",colorlab="") 
```



### Correlation Heatmap


```{r fig.width=8, fig.height=4}
options(error=recover)
CorrelationHeatmap(data=corrcounts_merge, 
                   metadata = metadata_merge, 
                   genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"), 
                   separate.by = "Condition", 
                   method = "pearson",  
                   colorlist = list(low = "#3F4193", mid = "#F9F4AE", high = "#B44141"),
                   limits_colorscale = c(-1,0,1), 
                   widthTitle = 16, 
                   title = "test", 
                   cluster_rows = TRUE, 
                   cluster_columns = TRUE,  
                   detailedresults = FALSE, 
                   legend_position="right",
                   titlesize=20)


```




### Expression Heatmaps

```{r fig.width=10, fig.height=4}
options(error=recover)

annotation_colors <- list(
  CellType = c(
    "Fibroblast"   = "#FF6961",   # Strong Pastel Red  
    "Keratinocyte" = "#FFB347",   # Strong Pastel Orange  
    "Melanocyte"   = "#FFD700",   # Strong Pastel Yellow  
    "Endothelial"  = "#77DD77",   # Strong Pastel Green  
    "Neuronal"     = "#779ECB",   # Strong Pastel Blue  
    "Mesenchymal"  = "#C27BA0"    # Strong Pastel Purple  
  ),
  Condition = c(
    "Senescent"     = "#65AC7C",  # Example color: greenish
    "Proliferative" = "#5F90D4",  # Example color: blueish
    "Quiescent"     = "#EDA03E"   # Example color: orange
  )
)

ExpressionHeatmap(data=corrcounts_merge, 
                  metadata = metadata_merge, 
                  genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"),  
                  annotate.by = c("CellType","Condition"),
                  annotation_colors = annotation_colors,
                  colorlist = list(low = "#3F4193", mid = "#F9F4AE", high = "#B44141"),
                  cluster_rows = TRUE, 
                  cluster_columns = FALSE,
                  title = "test", 
                  titlesize = 20,
                  legend_position = "right",
                  scale_position="right")

```



### ROC/AUC 

```{r fig.width=10, fig.height=4}

cellTypes_colors <- c(
  "Fibroblast" = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347", # Strong Pastel Orange  
  "Melanocyte" = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial" = "#77DD77",  # Strong Pastel Green  
  "Neuronal" = "#779ECB",     # Strong Pastel Blue  
  "Mesenchymal" = "#C27BA0"   # Strong Pastel Purple  
)

ROCandAUCplot(corrcounts_merge, 
              metadata_merge, 
              condition_var = "Condition", 
              class = "Senescent", 
              genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"), 
              group_var="CellType",
              plot_type = "all",
              heatmap_params = list(col = list( "#F9F4AE" ,"#B44141"),
                                    limits = c(0.5,1),
                                    cluster_rows=T),
              roc_params = list(nrow=2,
                                ncol=2,
                                colors=cellTypes_colors),
              commomplot_params = list(widths=c(0.5,0.5)))


```

### Cohen's d

```{r}
CohenDHeatmap(corrcounts_merge, 
              metadata_merge, 
              genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"),
              condition_var = "Condition", 
              class = "Senescent", 
              group_var = "CellType",
              title = NULL,
              widthTitle = 16,
              heatmap_params = list(col = list( "#F9F4AE" ,"#B44141"),
                                    limits = NULL,
                                    cluster_rows=T))
```

### PCA with genes from signature only

```{r fig.width=8, fig.height=4}

CellTypecols = c(
  "Fibroblast"   = "#FF6961",   # Strong Pastel Red  
  "Keratinocyte" = "#FFB347",   # Strong Pastel Orange  
  "Melanocyte"   = "#FFD700",   # Strong Pastel Yellow  
  "Endothelial"  = "#77DD77",   # Strong Pastel Green  
  "Neuronal"     = "#779ECB",   # Strong Pastel Blue  
  "Mesenchymal"  = "#C27BA0"    # Strong Pastel Purple  
)

sencols <- c(
  "Senescent" = "#D32F2F",  # Strong salmon  
  "Quiescent" = "#FFB74D",  # Bright peach  
  "Proliferative" = "#9575CD"  # Deep pastel purple  
)

plotPCA(data=corrcounts_merge, 
        metadata=metadata_merge, 
        genes=c("CDKN1A", "CDKN2A", "GLB1","TP53","CCL2"), 
        scale=FALSE, 
        center=TRUE, 
        PCs=list(c(1,2), c(2,3), c(3,4)), 
        ColorVariable="Condition",
        ColorValues=sencols,
        pointSize=5,
        legend_nrow=1, 
        ncol=3, 
        nrow=NULL)
```


# Enrichment-based

## GSEA


```{r}
options(error=recover)
degenes <- calculateDE(data=corrcounts_merge, 
                       metadata=metadata_merge, 
                       variables="Condition", 
                       lmexpression = NULL, 
                       modelmat = NULL, 
                       contrasts = c("Senescent - Proliferative",
                                     "Senescent - Quiescent",
                                     "Proliferative - Quiescent")) 

degenes
```

```{r fig.width=21, fig.height=6}
options(error=recover)
plotVolcano(DEResultsList=degenes, genes=bidirectsigs, N=NULL, x="logFC",y="-log10(adj.P.Val)", pointSize=2, color="pink", highlightcolor="darkblue", highlightcolor_upreg = "#038C65", highlightcolor_downreg = "#8C0303", nointerestcolor="grey",threshold_y=NULL, threshold_x=NULL, xlab=NULL, ylab=NULL, ncol=NULL, nrow=NULL, title=NULL,labsize=7,widthlabs=25, invert=T)

```



```{r}
options(error=recover)
GSEAresults <- runGSEA(degenes, bidirectsigs, stat = NULL)
GSEAresults
```


```{r fig.width=25, fig.height=10}
plotGSEAenrichment(GSEA_results=GSEAresults, DEGList=degenes, gene_sets=bidirectsigs, widthTitle=32,grid = T, titlesize = 10, nrow=3, ncol=9) 
```

```{r fig.width=18, fig.height=4}
options(error=recover)
plotNESlollipop(GSEA_results=GSEAresults, sig_threshold = 0.05,saturation_value=0.00001, nonsignif_color = "white", signif_color = "red",
                grid = T, nrow = 1, ncol = NULL, widthlabels=28, title=NULL)

```

```{r fig.width=10, fig.height=4.5}
plotCombinedGSEA(GSEAresults, sig_threshold = 0.05, PointSize=9, widthlegend = 26 )
```




## Association with Phenotype


If the user is investigating if a certain variable can be described from the GSEA results, and not already knowing that variable. More exploratory...

- For each variable, define all possible contrasts (e.g. if A,B,C, then consider A-B, A-C, B-C,A-(B+C)/2, etc...)
- Use calculateDE without baseline and all possible contrasts
- perform GSEA and collect all results in only one table
- Plot all results in lollipop plots, y axis with all contrasts

- One function to calculate all results; one to do the lollypop plot



```{r fig.width=6, fig.height=6}
options(error=recover)
df_test <- GSEA_VariableAssociation(data=corrcounts_merge, 
                                    metadata=metadata_merge_corr, 
                                    cols=c("Condition","Is_Senescent","random_cat","random_numeric"), 
                                    mode="extensive", 
                                    gene_set=list(HernandezSegura=bidirectsigs$HernandezSegura),  saturation_value=0.000000001, nonsignif_color = "white", signif_color = "red",
                                    sig_threshold = 0.05, widthlabels=30, labsize=10, titlesize=14) 

df_test$plot

```



```{r}
# metadata_corr_1 <- CalculateScores(data = corrcounts_merge, metadata = metadata_merge_corr, method = "ssGSEA", gene_sets = list(HernandezSegura=bidirectsigs$HernandezSegura) )
# metadata_corr <- metadata_corr_1$`HernandezSegura`
# metadata_corr
```

```{r fig.width=5, fig.height=10}
VariableAssociation(df=metadata_corr, cols=c("Condition","Is_Senescent","random_cat","random_numeric"), 
                    target_var="score", targetvar_lab="Score",
                    discrete_colors = list(Is_Senescent=c("Senescent"="pink",
                                                          "Non Senescent"="orange")), 
                    continuous_color = "#8C6D03",
                    color_palette = "Set2",
                    sizeannot=3, ncol=1, nrow=4,
                    numeric = "pearson",
                    categorical_bin = "t.test",
                    categorical_multi = "anova", title=NULL, titlesize=14,
                    nonsignif_color = "white", signif_color = "red", 
                    saturation_value=NULL,sig_threshold = 0.05, widthlabels=14, pointSize=5, heights=c(0.3,0.2,0.3,0.2)) 
```





```{r fig.width=6, fig.height=5}
options(error=recover)
df_test <- GSEA_VariableAssociation(data=corrcounts_merge, 
                                    metadata=metadata_merge_corr, 
                                    cols=c("Condition" ), 
                                    mode="medium", 
                                    gene_set=list(HernandezSegura_UP=SenescenceSignatures$`[UP]_HernandezSegura` ), 
                                    saturation_value=0.000000001, nonsignif_color = "white", signif_color = "red",
                                    sig_threshold = 0.05, widthlabels=30, labsize=10, titlesize=14) 

df_test$plot

df_test <- GSEA_VariableAssociation(data=corrcounts_merge, 
                                    metadata=metadata_merge_corr, 
                                    cols=c("Condition" ), 
                                    mode="medium", 
                                    gene_set=list( HernandezSegura_Bidirect_UP=subset(bidirectsigs$HernandezSegura, enrichment==1)), 
                                    saturation_value=0.000000001, nonsignif_color = "white", signif_color = "red",
                                    sig_threshold = 0.05, widthlabels=30, labsize=10, titlesize=14) 

df_test$plot


```
